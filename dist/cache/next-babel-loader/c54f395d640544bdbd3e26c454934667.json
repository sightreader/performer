{"ast":null,"code":"import _objectSpread from \"@babel/runtime-corejs2/helpers/esm/objectSpread\";\nimport _Promise from \"@babel/runtime-corejs2/core-js/promise\";\nimport _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport { Client } from \"./Client/Client\";\nimport msgpack from \"@ygoe/msgpack\";\nimport { EnumerateMidiDevicesRequest, EnumerateMidiDevicesResponse, Command, RequestResponse, SelectMidiDevicesResponse, SelectMidiDevicesRequest, EnumerateScoresResponse, EnumerateScoresRequest, LoadScoreResponse, LoadScoreRequest, SetScoreDisplayPositionRequest } from \"./Client/Commands/Command\";\nexport var SightReaderClient =\n/*#__PURE__*/\nfunction () {\n  function SightReaderClient() {\n    _classCallCheck(this, SightReaderClient);\n\n    _defineProperty(this, \"verovio\", void 0);\n\n    _defineProperty(this, \"client\", new Client());\n\n    _defineProperty(this, \"score\", \"\");\n\n    _defineProperty(this, \"onSetScoreDisplayPositionRequested\", function () {});\n  }\n\n  _createClass(SightReaderClient, [{\n    key: \"setSetScoreDisplayPositionRequestedCallback\",\n    value: function () {\n      var _setSetScoreDisplayPositionRequestedCallback = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee(onSetScoreDisplayPositionRequested) {\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                this.onSetScoreDisplayPositionRequested = onSetScoreDisplayPositionRequested;\n\n              case 1:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function setSetScoreDisplayPositionRequestedCallback(_x) {\n        return _setSetScoreDisplayPositionRequestedCallback.apply(this, arguments);\n      }\n\n      return setSetScoreDisplayPositionRequestedCallback;\n    }()\n  }, {\n    key: \"getVerovio\",\n    value: function () {\n      var _getVerovio = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee2() {\n        var _this = this;\n\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                return _context2.abrupt(\"return\", new _Promise(function (resolve, reject) {\n                  if (!_this.verovio) {\n                    _this.verovio = new window.verovio.toolkit();\n                  }\n\n                  resolve(_this.verovio);\n                }));\n\n              case 1:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      }));\n\n      function getVerovio() {\n        return _getVerovio.apply(this, arguments);\n      }\n\n      return getVerovio;\n    }()\n  }, {\n    key: \"setupScore\",\n    value: function () {\n      var _setupScore = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee3(verovioOptions) {\n        var _this2 = this;\n\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                return _context3.abrupt(\"return\", this.getVerovio().then(function (verovio) {\n                  var options = _objectSpread({\n                    font: \"Bravura\",\n                    slurThickness: 0.3,\n                    spacingNonLinear: 0.7,\n                    stemWidth: 0.3,\n                    svgViewBox: true,\n                    noHeader: true,\n                    noFooter: true,\n                    svgBoundingBoxes: false,\n                    breaks: \"auto\",\n                    pageMarginBottom: 0,\n                    pageMarginLeft: 10,\n                    pageMarginRight: 0,\n                    pageMarginTop: 0,\n                    scale: 1000\n                  }, verovioOptions);\n\n                  console.log(\"Setting up Verovio with options:\", options);\n\n                  _this2.verovio.setOptions(options);\n\n                  verovio.loadData(_this2.score);\n                }));\n\n              case 1:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function setupScore(_x2) {\n        return _setupScore.apply(this, arguments);\n      }\n\n      return setupScore;\n    }()\n  }, {\n    key: \"renderScore\",\n    value: function () {\n      var _renderScore = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee4(pageNumber) {\n        var _this3 = this;\n\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                return _context4.abrupt(\"return\", new _Promise(function (resolve, reject) {\n                  return _this3.getVerovio().then(function (verovio) {\n                    console.log(\"verovio.rendertsvg:\", verovio);\n                    window.verovio3 = verovio;\n                    resolve(verovio.renderToSVG(pageNumber));\n                  });\n                }));\n\n              case 1:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4);\n      }));\n\n      function renderScore(_x3) {\n        return _renderScore.apply(this, arguments);\n      }\n\n      return renderScore;\n    }()\n  }, {\n    key: \"setScore\",\n    value: function setScore(score) {\n      this.score = new TextDecoder(\"utf-8\").decode(score);\n    }\n  }, {\n    key: \"connectCheck\",\n    value: function () {\n      var _connectCheck = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee5() {\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                if (!(!this.client.Socket || this.client.Socket.readyState !== this.client.Socket.OPEN)) {\n                  _context5.next = 4;\n                  break;\n                }\n\n                _context5.next = 3;\n                return this.client.connect();\n\n              case 3:\n                this.addMessageHandlerForSetScoreDisplayPosition();\n\n              case 4:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function connectCheck() {\n        return _connectCheck.apply(this, arguments);\n      }\n\n      return connectCheck;\n    }()\n  }, {\n    key: \"addMessageHandlerForSetScoreDisplayPosition\",\n    value: function addMessageHandlerForSetScoreDisplayPosition() {\n      var self = this;\n\n      function onResponse(_x4) {\n        return _onResponse.apply(this, arguments);\n      }\n\n      function _onResponse() {\n        _onResponse = _asyncToGenerator(\n        /*#__PURE__*/\n        _regeneratorRuntime.mark(function _callee6(event) {\n          var buffer, message, command;\n          return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n            while (1) {\n              switch (_context6.prev = _context6.next) {\n                case 0:\n                  _context6.next = 2;\n                  return new Response(event.data).arrayBuffer();\n\n                case 2:\n                  buffer = _context6.sent;\n                  message = msgpack.deserialize(buffer);\n\n                  if (!(message.Command !== Command.SetScoreDisplayPosition && message.Kind !== RequestResponse.Request)) {\n                    _context6.next = 6;\n                    break;\n                  }\n\n                  return _context6.abrupt(\"return\");\n\n                case 6:\n                  if (typeof self.onSetScoreDisplayPositionRequested === \"function\") {\n                    command = SetScoreDisplayPositionRequest.FromMessagePack(message);\n                    self.onSetScoreDisplayPositionRequested(command);\n                  }\n\n                case 7:\n                case \"end\":\n                  return _context6.stop();\n              }\n            }\n          }, _callee6);\n        }));\n        return _onResponse.apply(this, arguments);\n      }\n\n      console.log(\"Adding message handler for set score display position...\");\n      this.client.Socket.addEventListener(\"message\", onResponse);\n    }\n  }, {\n    key: \"EnumerateMidiDevices\",\n    value: function () {\n      var _EnumerateMidiDevices = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee7() {\n        return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                return _context7.abrupt(\"return\", this.SendRequest(new EnumerateMidiDevicesRequest(), Command.SelectMidiDevices, EnumerateMidiDevicesResponse));\n\n              case 1:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this);\n      }));\n\n      function EnumerateMidiDevices() {\n        return _EnumerateMidiDevices.apply(this, arguments);\n      }\n\n      return EnumerateMidiDevices;\n    }()\n  }, {\n    key: \"SelectMidiDevices\",\n    value: function () {\n      var _SelectMidiDevices = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee8(inputDeviceNames, outputDeviceNames) {\n        return _regeneratorRuntime.wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                return _context8.abrupt(\"return\", this.SendRequest(new SelectMidiDevicesRequest({\n                  InputDeviceNames: inputDeviceNames,\n                  OutputDeviceNames: outputDeviceNames\n                }), Command.SelectMidiDevices, SelectMidiDevicesResponse));\n\n              case 1:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, this);\n      }));\n\n      function SelectMidiDevices(_x5, _x6) {\n        return _SelectMidiDevices.apply(this, arguments);\n      }\n\n      return SelectMidiDevices;\n    }()\n  }, {\n    key: \"EnumerateScores\",\n    value: function () {\n      var _EnumerateScores = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee9() {\n        return _regeneratorRuntime.wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                return _context9.abrupt(\"return\", this.SendRequest(new EnumerateScoresRequest(), Command.EnumerateScores, EnumerateScoresResponse));\n\n              case 1:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9, this);\n      }));\n\n      function EnumerateScores() {\n        return _EnumerateScores.apply(this, arguments);\n      }\n\n      return EnumerateScores;\n    }()\n  }, {\n    key: \"LoadScore\",\n    value: function () {\n      var _LoadScore = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee10(scoreFilePath) {\n        var command;\n        return _regeneratorRuntime.wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                command = new LoadScoreRequest();\n                command.FilePath = scoreFilePath;\n                return _context10.abrupt(\"return\", this.SendRequest(command, Command.LoadScore, LoadScoreResponse));\n\n              case 3:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this);\n      }));\n\n      function LoadScore(_x7) {\n        return _LoadScore.apply(this, arguments);\n      }\n\n      return LoadScore;\n    }()\n  }, {\n    key: \"ConstructCommandResponse\",\n    value: function ConstructCommandResponse(instance, message) {\n      switch (instance.constructor) {\n        case EnumerateMidiDevicesResponse:\n          return EnumerateMidiDevicesResponse.FromMessagePack(message);\n\n        case SelectMidiDevicesResponse:\n          return SelectMidiDevicesResponse.FromMessagePack(message);\n\n        case EnumerateScoresResponse:\n          return EnumerateScoresResponse.FromMessagePack(message);\n\n        case LoadScoreResponse:\n          return LoadScoreResponse.FromMessagePack(message);\n\n        default:\n          console.error(\"Unable to construct command response for (instance, message):\", instance, message);\n          break;\n      }\n    }\n  }, {\n    key: \"SendRequest\",\n    value: function () {\n      var _SendRequest = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee12(requestCommand, command, ResponseType) {\n        var _this4 = this;\n\n        var self;\n        return _regeneratorRuntime.wrap(function _callee12$(_context12) {\n          while (1) {\n            switch (_context12.prev = _context12.next) {\n              case 0:\n                _context12.next = 2;\n                return this.connectCheck();\n\n              case 2:\n                self = this;\n                return _context12.abrupt(\"return\", new _Promise(function (resolve, reject) {\n                  function onResponse(_x11) {\n                    return _onResponse2.apply(this, arguments);\n                  }\n\n                  function _onResponse2() {\n                    _onResponse2 = _asyncToGenerator(\n                    /*#__PURE__*/\n                    _regeneratorRuntime.mark(function _callee11(event) {\n                      var buffer, message;\n                      return _regeneratorRuntime.wrap(function _callee11$(_context11) {\n                        while (1) {\n                          switch (_context11.prev = _context11.next) {\n                            case 0:\n                              _context11.next = 2;\n                              return new Response(event.data).arrayBuffer();\n\n                            case 2:\n                              buffer = _context11.sent;\n                              message = msgpack.deserialize(buffer);\n\n                              if (!(message.Command !== command && message.Kind !== RequestResponse.Response)) {\n                                _context11.next = 6;\n                                break;\n                              }\n\n                              return _context11.abrupt(\"return\");\n\n                            case 6:\n                              self.client.Socket.removeEventListener(\"message\", onResponse);\n                              resolve(self.ConstructCommandResponse(new ResponseType(), message));\n\n                            case 8:\n                            case \"end\":\n                              return _context11.stop();\n                          }\n                        }\n                      }, _callee11);\n                    }));\n                    return _onResponse2.apply(this, arguments);\n                  }\n\n                  _this4.client.Socket.addEventListener(\"message\", onResponse);\n\n                  console.log(\"[Socket -> Peer] Sending:\", requestCommand);\n\n                  _this4.client.Socket.send(msgpack.serialize(requestCommand));\n                }));\n\n              case 4:\n              case \"end\":\n                return _context12.stop();\n            }\n          }\n        }, _callee12, this);\n      }));\n\n      function SendRequest(_x8, _x9, _x10) {\n        return _SendRequest.apply(this, arguments);\n      }\n\n      return SendRequest;\n    }()\n  }, {\n    key: \"Score\",\n    get: function get() {\n      return this.score;\n    }\n  }], [{\n    key: \"Instance\",\n    get: function get() {\n      return SightReaderClient.instance;\n    }\n  }]);\n\n  return SightReaderClient;\n}();\n\n_defineProperty(SightReaderClient, \"instance\", new SightReaderClient());","map":{"version":3,"sources":["C:/code/sightreader/performer/src/SightReaderClient.ts"],"names":["Client","msgpack","EnumerateMidiDevicesRequest","EnumerateMidiDevicesResponse","Command","RequestResponse","SelectMidiDevicesResponse","SelectMidiDevicesRequest","EnumerateScoresResponse","EnumerateScoresRequest","LoadScoreResponse","LoadScoreRequest","SetScoreDisplayPositionRequest","SightReaderClient","onSetScoreDisplayPositionRequested","resolve","reject","verovio","window","toolkit","verovioOptions","getVerovio","then","options","font","slurThickness","spacingNonLinear","stemWidth","svgViewBox","noHeader","noFooter","svgBoundingBoxes","breaks","pageMarginBottom","pageMarginLeft","pageMarginRight","pageMarginTop","scale","console","log","setOptions","loadData","score","pageNumber","verovio3","renderToSVG","TextDecoder","decode","client","Socket","readyState","OPEN","connect","addMessageHandlerForSetScoreDisplayPosition","self","onResponse","event","Response","data","arrayBuffer","buffer","message","deserialize","SetScoreDisplayPosition","Kind","Request","command","FromMessagePack","addEventListener","SendRequest","SelectMidiDevices","inputDeviceNames","outputDeviceNames","InputDeviceNames","OutputDeviceNames","EnumerateScores","scoreFilePath","FilePath","LoadScore","instance","constructor","error","requestCommand","ResponseType","connectCheck","removeEventListener","ConstructCommandResponse","send","serialize"],"mappings":"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","sourcesContent":["import { Client } from \"./Client/Client\";\r\nimport msgpack from \"@ygoe/msgpack\";\r\nimport {\r\n  EnumerateMidiDevicesRequest,\r\n  EnumerateMidiDevicesResponse,\r\n  Command,\r\n  RequestResponse,\r\n  SelectMidiDevicesResponse,\r\n  SelectMidiDevicesRequest,\r\n  EnumerateScoresResponse,\r\n  EnumerateScoresRequest,\r\n  LoadScoreResponse,\r\n  LoadScoreRequest,\r\n  SetScoreDisplayPositionRequest\r\n} from \"./Client/Commands/Command\";\r\n\r\nexport class SightReaderClient {\r\n  private verovio: any;\r\n  private client: Client = new Client();\r\n  private score: string = \"\";\r\n  private onSetScoreDisplayPositionRequested: Function = () => {};\r\n  private static instance: SightReaderClient = new SightReaderClient();\r\n\r\n  public static get Instance() {\r\n    return SightReaderClient.instance;\r\n  }\r\n\r\n  async setSetScoreDisplayPositionRequestedCallback(\r\n    onSetScoreDisplayPositionRequested: Function\r\n  ) {\r\n    this.onSetScoreDisplayPositionRequested = onSetScoreDisplayPositionRequested;\r\n  }\r\n\r\n  async getVerovio() {\r\n    return new Promise((resolve, reject) => {\r\n      if (!this.verovio) {\r\n        this.verovio = new (window as any).verovio.toolkit();\r\n      }\r\n\r\n      resolve(this.verovio);\r\n    });\r\n  }\r\n\r\n  async setupScore(verovioOptions: any) {\r\n    return this.getVerovio().then((verovio: any) => {\r\n      var options = {\r\n        font: \"Bravura\",\r\n        slurThickness: 0.3,\r\n        spacingNonLinear: 0.7,\r\n        stemWidth: 0.3,\r\n        svgViewBox: true,\r\n        noHeader: true,\r\n        noFooter: true,\r\n        svgBoundingBoxes: false,\r\n        breaks: \"auto\",\r\n        pageMarginBottom: 0,\r\n        pageMarginLeft: 10,\r\n        pageMarginRight: 0,\r\n        pageMarginTop: 0,\r\n        scale: 1000,\r\n        ...verovioOptions\r\n      };\r\n      console.log(\"Setting up Verovio with options:\", options);\r\n      this.verovio.setOptions(options);\r\n      verovio.loadData(this.score);\r\n    });\r\n  }\r\n\r\n  async renderScore(pageNumber: number) {\r\n    return new Promise((resolve, reject) => {\r\n      return this.getVerovio().then((verovio: any) => {\r\n        console.log(\"verovio.rendertsvg:\", verovio);\r\n        (window as any).verovio3 = verovio;\r\n        resolve(verovio.renderToSVG(pageNumber));\r\n      });\r\n    });\r\n  }\r\n\r\n  get Score() {\r\n    return this.score;\r\n  }\r\n\r\n  setScore(score: Uint8Array) {\r\n    this.score = new TextDecoder(\"utf-8\").decode(score);\r\n  }\r\n\r\n  private async connectCheck() {\r\n    if (\r\n      !this.client.Socket ||\r\n      this.client.Socket.readyState !== this.client.Socket.OPEN\r\n    ) {\r\n      await this.client.connect();\r\n      this.addMessageHandlerForSetScoreDisplayPosition();\r\n    }\r\n  }\r\n\r\n  private addMessageHandlerForSetScoreDisplayPosition() {\r\n    var self = this;\r\n    async function onResponse(event: MessageEvent) {\r\n      const buffer = await new Response(event.data as Blob).arrayBuffer();\r\n      var message = msgpack.deserialize(buffer);\r\n\r\n      if (\r\n        message.Command !== Command.SetScoreDisplayPosition &&\r\n        message.Kind !== RequestResponse.Request\r\n      ) {\r\n        return;\r\n      }\r\n\r\n      if (typeof self.onSetScoreDisplayPositionRequested === \"function\") {\r\n        var command = SetScoreDisplayPositionRequest.FromMessagePack(message);\r\n        self.onSetScoreDisplayPositionRequested(command);\r\n      }\r\n    }\r\n\r\n    console.log(\"Adding message handler for set score display position...\");\r\n    this.client.Socket.addEventListener(\"message\", onResponse);\r\n  }\r\n\r\n  async EnumerateMidiDevices(): Promise<EnumerateMidiDevicesResponse> {\r\n    return this.SendRequest(\r\n      new EnumerateMidiDevicesRequest(),\r\n      Command.SelectMidiDevices,\r\n      EnumerateMidiDevicesResponse\r\n    );\r\n  }\r\n\r\n  async SelectMidiDevices(\r\n    inputDeviceNames: string[],\r\n    outputDeviceNames: string[]\r\n  ): Promise<SelectMidiDevicesResponse> {\r\n    return this.SendRequest(\r\n      new SelectMidiDevicesRequest({\r\n        InputDeviceNames: inputDeviceNames,\r\n        OutputDeviceNames: outputDeviceNames\r\n      }),\r\n      Command.SelectMidiDevices,\r\n      SelectMidiDevicesResponse\r\n    );\r\n  }\r\n\r\n  async EnumerateScores(): Promise<EnumerateScoresResponse> {\r\n    return this.SendRequest(\r\n      new EnumerateScoresRequest(),\r\n      Command.EnumerateScores,\r\n      EnumerateScoresResponse\r\n    );\r\n  }\r\n\r\n  async LoadScore(scoreFilePath: string): Promise<LoadScoreResponse> {\r\n    var command = new LoadScoreRequest();\r\n    command.FilePath = scoreFilePath;\r\n\r\n    return this.SendRequest(command, Command.LoadScore, LoadScoreResponse);\r\n  }\r\n\r\n  private ConstructCommandResponse<T>(instance: T, message: any): any {\r\n    switch ((instance as any).constructor) {\r\n      case EnumerateMidiDevicesResponse:\r\n        return EnumerateMidiDevicesResponse.FromMessagePack(message);\r\n      case SelectMidiDevicesResponse:\r\n        return SelectMidiDevicesResponse.FromMessagePack(message);\r\n      case EnumerateScoresResponse:\r\n        return EnumerateScoresResponse.FromMessagePack(message);\r\n      case LoadScoreResponse:\r\n        return LoadScoreResponse.FromMessagePack(message);\r\n      default:\r\n        console.error(\r\n          \"Unable to construct command response for (instance, message):\",\r\n          instance,\r\n          message\r\n        );\r\n        break;\r\n    }\r\n  }\r\n\r\n  private async SendRequest<TRequest, TResponse>(\r\n    requestCommand: any,\r\n    command: Command,\r\n    ResponseType: any\r\n  ): Promise<TResponse> {\r\n    await this.connectCheck();\r\n\r\n    var self = this;\r\n    return new Promise((resolve, reject) => {\r\n      async function onResponse(event: MessageEvent) {\r\n        const buffer = await new Response(event.data as Blob).arrayBuffer();\r\n        var message = msgpack.deserialize(buffer);\r\n\r\n        if (\r\n          message.Command !== command &&\r\n          message.Kind !== RequestResponse.Response\r\n        ) {\r\n          return;\r\n        }\r\n\r\n        self.client.Socket.removeEventListener(\"message\", onResponse);\r\n        resolve(self.ConstructCommandResponse(new ResponseType(), message));\r\n      }\r\n\r\n      this.client.Socket.addEventListener(\"message\", onResponse);\r\n      console.log(\"[Socket -> Peer] Sending:\", requestCommand);\r\n      this.client.Socket.send(msgpack.serialize(requestCommand));\r\n    });\r\n  }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}
{"ast":null,"code":"import _objectSpread from \"@babel/runtime-corejs2/helpers/esm/objectSpread\";\nimport _Promise from \"@babel/runtime-corejs2/core-js/promise\";\nimport _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport { Client } from \"./Client/Client\";\nimport msgpack from \"@ygoe/msgpack\";\nimport { EnumerateMidiDevicesRequest, EnumerateMidiDevicesResponse, Command, RequestResponse, SelectMidiDevicesResponse, SelectMidiDevicesRequest, EnumerateScoresResponse, EnumerateScoresRequest, LoadScoreResponse, LoadScoreRequest, SetScoreDisplayPositionRequest } from \"./Client/Commands/Command\";\nexport var SightReaderClient =\n/*#__PURE__*/\nfunction () {\n  function SightReaderClient() {\n    _classCallCheck(this, SightReaderClient);\n\n    _defineProperty(this, \"verovio\", void 0);\n\n    _defineProperty(this, \"client\", new Client());\n\n    _defineProperty(this, \"score\", \"\");\n\n    _defineProperty(this, \"onSetScoreDisplayPositionRequested\", function () {});\n  }\n\n  _createClass(SightReaderClient, [{\n    key: \"setSetScoreDisplayPositionRequestedCallback\",\n    value: function () {\n      var _setSetScoreDisplayPositionRequestedCallback = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee(onSetScoreDisplayPositionRequested) {\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                this.onSetScoreDisplayPositionRequested = onSetScoreDisplayPositionRequested;\n\n              case 1:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function setSetScoreDisplayPositionRequestedCallback(_x) {\n        return _setSetScoreDisplayPositionRequestedCallback.apply(this, arguments);\n      }\n\n      return setSetScoreDisplayPositionRequestedCallback;\n    }()\n  }, {\n    key: \"getVerovio\",\n    value: function () {\n      var _getVerovio = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee2() {\n        var _this = this;\n\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                return _context2.abrupt(\"return\", new _Promise(function (resolve, reject) {\n                  if (!_this.verovio) {\n                    _this.verovio = new window.verovio.toolkit();\n                  }\n\n                  resolve(_this.verovio);\n                }));\n\n              case 1:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      }));\n\n      function getVerovio() {\n        return _getVerovio.apply(this, arguments);\n      }\n\n      return getVerovio;\n    }()\n  }, {\n    key: \"setupScore\",\n    value: function () {\n      var _setupScore = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee3(verovioOptions) {\n        var _this2 = this;\n\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                return _context3.abrupt(\"return\", this.getVerovio().then(function (verovio) {\n                  var options = _objectSpread({\n                    font: \"Bravura\",\n                    slurThickness: 0.3,\n                    spacingNonLinear: 0.7,\n                    stemWidth: 0.3,\n                    svgViewBox: true,\n                    noHeader: true,\n                    noFooter: true,\n                    svgBoundingBoxes: false,\n                    breaks: \"auto\",\n                    pageMarginBottom: 0,\n                    pageMarginLeft: 10,\n                    pageMarginRight: 0,\n                    pageMarginTop: 0,\n                    scale: 1000\n                  }, verovioOptions);\n\n                  console.log(\"Setting up Verovio with options:\", options);\n\n                  _this2.verovio.setOptions(options);\n\n                  verovio.loadData(_this2.score);\n                }));\n\n              case 1:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function setupScore(_x2) {\n        return _setupScore.apply(this, arguments);\n      }\n\n      return setupScore;\n    }()\n  }, {\n    key: \"renderScore\",\n    value: function () {\n      var _renderScore = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee4(pageNumber) {\n        var _this3 = this;\n\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                return _context4.abrupt(\"return\", new _Promise(function (resolve, reject) {\n                  return _this3.getVerovio().then(function (verovio) {\n                    console.log(\"verovio.rendertsvg:\", verovio);\n                    window.verovio3 = verovio;\n                    resolve(verovio.renderToSVG(pageNumber));\n                  });\n                }));\n\n              case 1:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4);\n      }));\n\n      function renderScore(_x3) {\n        return _renderScore.apply(this, arguments);\n      }\n\n      return renderScore;\n    }()\n  }, {\n    key: \"setScore\",\n    value: function setScore(score) {\n      this.score = new TextDecoder(\"utf-8\").decode(score);\n    }\n  }, {\n    key: \"connectCheck\",\n    value: function () {\n      var _connectCheck = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee5() {\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                if (!(!this.client.Socket || this.client.Socket.readyState !== this.client.Socket.OPEN)) {\n                  _context5.next = 4;\n                  break;\n                }\n\n                _context5.next = 3;\n                return this.client.connect();\n\n              case 3:\n                this.addMessageHandlerForSetScoreDisplayPosition();\n\n              case 4:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function connectCheck() {\n        return _connectCheck.apply(this, arguments);\n      }\n\n      return connectCheck;\n    }()\n  }, {\n    key: \"addMessageHandlerForSetScoreDisplayPosition\",\n    value: function addMessageHandlerForSetScoreDisplayPosition() {\n      var self = this;\n\n      function onResponse(_x4) {\n        return _onResponse.apply(this, arguments);\n      }\n\n      function _onResponse() {\n        _onResponse = _asyncToGenerator(\n        /*#__PURE__*/\n        _regeneratorRuntime.mark(function _callee6(event) {\n          var buffer, message, command;\n          return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n            while (1) {\n              switch (_context6.prev = _context6.next) {\n                case 0:\n                  _context6.next = 2;\n                  return new Response(event.data).arrayBuffer();\n\n                case 2:\n                  buffer = _context6.sent;\n                  message = msgpack.deserialize(buffer);\n\n                  if (!(message.Command !== Command.SetScoreDisplayPosition && message.Kind !== RequestResponse.Request)) {\n                    _context6.next = 6;\n                    break;\n                  }\n\n                  return _context6.abrupt(\"return\");\n\n                case 6:\n                  if (typeof self.onSetScoreDisplayPositionRequested === \"function\") {\n                    command = SetScoreDisplayPositionRequest.FromMessagePack(message);\n                    self.onSetScoreDisplayPositionRequested(command);\n                  }\n\n                case 7:\n                case \"end\":\n                  return _context6.stop();\n              }\n            }\n          }, _callee6);\n        }));\n        return _onResponse.apply(this, arguments);\n      }\n\n      console.log(\"Adding message handler for set score display position...\");\n      this.client.Socket.addEventListener(\"message\", onResponse);\n    }\n  }, {\n    key: \"EnumerateMidiDevices\",\n    value: function () {\n      var _EnumerateMidiDevices = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee7() {\n        return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                return _context7.abrupt(\"return\", this.SendRequest(new EnumerateMidiDevicesRequest(), Command.SelectMidiDevices, EnumerateMidiDevicesResponse));\n\n              case 1:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this);\n      }));\n\n      function EnumerateMidiDevices() {\n        return _EnumerateMidiDevices.apply(this, arguments);\n      }\n\n      return EnumerateMidiDevices;\n    }()\n  }, {\n    key: \"SelectMidiDevices\",\n    value: function () {\n      var _SelectMidiDevices = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee8(inputDeviceNames, outputDeviceNames) {\n        return _regeneratorRuntime.wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                return _context8.abrupt(\"return\", this.SendRequest(new SelectMidiDevicesRequest({\n                  InputDeviceNames: inputDeviceNames,\n                  OutputDeviceNames: outputDeviceNames\n                }), Command.SelectMidiDevices, SelectMidiDevicesResponse));\n\n              case 1:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, this);\n      }));\n\n      function SelectMidiDevices(_x5, _x6) {\n        return _SelectMidiDevices.apply(this, arguments);\n      }\n\n      return SelectMidiDevices;\n    }()\n  }, {\n    key: \"EnumerateScores\",\n    value: function () {\n      var _EnumerateScores = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee9() {\n        return _regeneratorRuntime.wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                return _context9.abrupt(\"return\", this.SendRequest(new EnumerateScoresRequest(), Command.EnumerateScores, EnumerateScoresResponse));\n\n              case 1:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9, this);\n      }));\n\n      function EnumerateScores() {\n        return _EnumerateScores.apply(this, arguments);\n      }\n\n      return EnumerateScores;\n    }()\n  }, {\n    key: \"LoadScore\",\n    value: function () {\n      var _LoadScore = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee10(scoreFilePath) {\n        var command;\n        return _regeneratorRuntime.wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                command = new LoadScoreRequest();\n                command.FilePath = scoreFilePath;\n                return _context10.abrupt(\"return\", this.SendRequest(command, Command.LoadScore, LoadScoreResponse));\n\n              case 3:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this);\n      }));\n\n      function LoadScore(_x7) {\n        return _LoadScore.apply(this, arguments);\n      }\n\n      return LoadScore;\n    }()\n  }, {\n    key: \"ConstructCommandResponse\",\n    value: function ConstructCommandResponse(instance, message) {\n      switch (instance.constructor) {\n        case EnumerateMidiDevicesResponse:\n          return EnumerateMidiDevicesResponse.FromMessagePack(message);\n\n        case SelectMidiDevicesResponse:\n          return SelectMidiDevicesResponse.FromMessagePack(message);\n\n        case EnumerateScoresResponse:\n          return EnumerateScoresResponse.FromMessagePack(message);\n\n        case LoadScoreResponse:\n          return LoadScoreResponse.FromMessagePack(message);\n\n        default:\n          console.error(\"Unable to construct command response for (instance, message):\", instance, message);\n          break;\n      }\n    }\n  }, {\n    key: \"SendRequest\",\n    value: function () {\n      var _SendRequest = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee12(requestCommand, command, ResponseType) {\n        var _this4 = this;\n\n        var self;\n        return _regeneratorRuntime.wrap(function _callee12$(_context12) {\n          while (1) {\n            switch (_context12.prev = _context12.next) {\n              case 0:\n                _context12.next = 2;\n                return this.connectCheck();\n\n              case 2:\n                self = this;\n                return _context12.abrupt(\"return\", new _Promise(function (resolve, reject) {\n                  function onResponse(_x11) {\n                    return _onResponse2.apply(this, arguments);\n                  }\n\n                  function _onResponse2() {\n                    _onResponse2 = _asyncToGenerator(\n                    /*#__PURE__*/\n                    _regeneratorRuntime.mark(function _callee11(event) {\n                      var buffer, message;\n                      return _regeneratorRuntime.wrap(function _callee11$(_context11) {\n                        while (1) {\n                          switch (_context11.prev = _context11.next) {\n                            case 0:\n                              _context11.next = 2;\n                              return new Response(event.data).arrayBuffer();\n\n                            case 2:\n                              buffer = _context11.sent;\n                              message = msgpack.deserialize(buffer);\n\n                              if (!(message.Command !== command && message.Kind !== RequestResponse.Response)) {\n                                _context11.next = 6;\n                                break;\n                              }\n\n                              return _context11.abrupt(\"return\");\n\n                            case 6:\n                              self.client.Socket.removeEventListener(\"message\", onResponse);\n                              resolve(self.ConstructCommandResponse(new ResponseType(), message));\n\n                            case 8:\n                            case \"end\":\n                              return _context11.stop();\n                          }\n                        }\n                      }, _callee11);\n                    }));\n                    return _onResponse2.apply(this, arguments);\n                  }\n\n                  _this4.client.Socket.addEventListener(\"message\", onResponse);\n\n                  console.log(\"[Socket -> Peer] Sending:\", requestCommand);\n\n                  _this4.client.Socket.send(msgpack.serialize(requestCommand));\n                }));\n\n              case 4:\n              case \"end\":\n                return _context12.stop();\n            }\n          }\n        }, _callee12, this);\n      }));\n\n      function SendRequest(_x8, _x9, _x10) {\n        return _SendRequest.apply(this, arguments);\n      }\n\n      return SendRequest;\n    }()\n  }, {\n    key: \"Score\",\n    get: function get() {\n      return this.score;\n    }\n  }], [{\n    key: \"Instance\",\n    get: function get() {\n      return SightReaderClient.instance;\n    }\n  }]);\n\n  return SightReaderClient;\n}();\n\n_defineProperty(SightReaderClient, \"instance\", new SightReaderClient());","map":null,"metadata":{},"sourceType":"module"}